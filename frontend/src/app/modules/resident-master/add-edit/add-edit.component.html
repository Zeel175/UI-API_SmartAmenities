<div class="bg-card flex min-w-0 flex-auto flex-col dark:bg-transparent">
  <div class="relative flex flex-0 flex-col border-b px-6 py-8 sm:flex-row sm:items-center sm:justify-between md:px-8">
    <div class="text-4xl font-extrabold tracking-tight">{{ isEditMode ? 'Edit Resident' : 'Add Resident' }}</div>
    <div class="mt-6 flex shrink-0 items-center sm:ml-4 sm:mt-0">
      <button mat-flat-button color="primary" class="app-button back-Green" (click)="cancel()">View List</button>
    </div>
  </div>

  <div class="flex flex-auto overflow-visible">
    <div class="flex flex-auto flex-col overflow-visible sm:mb-18 sm:overflow-y-auto">
      <mat-card class="mt-4 mx-6 md:mx-8">
        <mat-card-content>
          <form [formGroup]="frmResident" (ngSubmit)="save()" novalidate class="app-form">
            <div class="grid grid-cols-1 gap-4 md:grid-cols-2 lg:grid-cols-3 auto-rows-min">

              <mat-form-field appearance="outline" class="w-full">
                <mat-label>Code</mat-label>
                <input matInput formControlName="code" readonly />
              </mat-form-field>

              <mat-form-field appearance="outline" class="w-full">
                <mat-label>Parent First Name</mat-label>
                <input matInput formControlName="parentFirstName" />
                <mat-error
                  *ngIf="frmResident.get('parentFirstName')?.invalid && frmResident.get('parentFirstName')?.touched">
                  Parent first name is required.
                </mat-error>
              </mat-form-field>

              <mat-form-field appearance="outline" class="w-full">
                <mat-label>Parent Last Name</mat-label>
                <input matInput formControlName="parentLastName" />
                <mat-error
                  *ngIf="frmResident.get('parentLastName')?.invalid && frmResident.get('parentLastName')?.touched">
                  Parent last name is required.
                </mat-error>
              </mat-form-field>

              <mat-form-field appearance="outline" class="w-full">
                <mat-label>Email</mat-label>
                <input matInput formControlName="email" />
                <mat-error *ngIf="frmResident.get('email')?.invalid && frmResident.get('email')?.touched">
                  Enter a valid email.
                </mat-error>
              </mat-form-field>

              <mat-form-field appearance="outline" class="w-full">
                <mat-label>Mobile</mat-label>
                <input matInput formControlName="mobile" />
              </mat-form-field>

              <mat-form-field appearance="outline" class="w-full">
                <mat-label>Units</mat-label>
                <mat-select formControlName="unitIds" multiple>
                  <mat-option *ngFor="let unit of units" [value]="unit.id">
                    {{ unit.buildingName || unit.building?.buildingName || unit.building?.name }} - {{ unit.unitName ||
                    unit.name }}
                  </mat-option>
                </mat-select>
              </mat-form-field>

              <mat-form-field appearance="outline" class="w-full">
                <mat-label>Face Id</mat-label>
                <input matInput formControlName="faceId" />
              </mat-form-field>

              <mat-form-field appearance="outline" class="w-full">
                <mat-label>Finger Id</mat-label>
                <input matInput formControlName="fingerId" />
              </mat-form-field>

              <mat-form-field appearance="outline" class="w-full">
                <mat-label>Card Id</mat-label>
                <input matInput formControlName="cardId" />
              </mat-form-field>

              <mat-form-field appearance="outline" class="w-full">
                <mat-label>Qr Id</mat-label>
                <input matInput formControlName="qrId" />
              </mat-form-field>
              <mat-checkbox class="w-full" formControlName="isResident">Add User</mat-checkbox>

              <!-- Profile Photo -->
              <div class="w-full lg:col-span-3 profile-photo-section">
                <label class="profile-photo-title">
                  Profile Photo
                </label>

                <div class="profile-photo-card">
                  <img *ngIf="profilePhotoPreview" [src]="profilePhotoPreview" alt="Profile Photo"
                    class="profile-photo-img" />

                  <div *ngIf="!profilePhotoPreview" class="profile-photo-placeholder">
                    <mat-icon>person</mat-icon>
                    <span>No Photo</span>
                  </div>
                </div>

                <button mat-flat-button color="primary" type="button" class="upload-photo-btn"
                  (click)="fileInput.click()">
                  <mat-icon>photo_camera</mat-icon>
                  Upload Photo
                </button>

                <input #fileInput type="file" accept="image/*" hidden (change)="onProfilePhotoSelected($event)" />
              </div>
              <!-- Resident Documents -->
            <!-- ================= DOCUMENT UPLOAD ================= -->
<div class="w-full lg:col-span-3 mt-6">
  <div class="flex items-center justify-between">
    <label class="text-xl font-semibold">Documents</label>

    <button mat-stroked-button color="primary" type="button"
            (click)="docInput.click()">
        <mat-icon>upload_file</mat-icon>
        Upload Documents
    </button>
  </div>

    <input #docInput type="file" multiple hidden
           (change)="onDocumentsSelected($event)" />

    <!-- Selected (not saved yet) -->
    <div *ngIf="selectedDocuments.length" class="mt-3">
        <h4 class="font-medium">Selected Files</h4>

        <div *ngFor="let file of selectedDocuments; let i = index"
             class="flex items-center justify-between border p-2 rounded mt-2">
              <a
  href="javascript:void(0)"
  class="text-blue-600 underline truncate"
  (click)="openSelectedDocument(file)">
  {{ file.name }}
</a>


            <button mat-icon-button color="warn"
                    type="button"
                    (click)="removeSelectedDocument(i)">
                <mat-icon>close</mat-icon>
            </button>
        </div>
    </div>

    <!-- Existing Documents (edit mode) -->
    <div *ngIf="existingDocuments.length" class="mt-4">
        <h4 class="font-medium">Uploaded Documents</h4>

        <div *ngFor="let doc of existingDocuments"
             class="flex items-center justify-between border p-2 rounded mt-2">
           <a [href]="getDocumentUrl(doc.filePath)"
   target="_blank"
   rel="noopener noreferrer"
   class="text-blue-600 underline truncate">
    {{ doc.fileName }}
</a>


            <button mat-icon-button color="warn"
                    type="button"
                    (click)="deleteExistingDocument(doc.id)">
                <mat-icon>delete</mat-icon>
            </button>
        </div>
    </div>
</div>




            </div>

            <div class="mt-8 space-y-4">
              <div class="flex items-center justify-between">
                <h3 class="text-2xl font-semibold">Family Members</h3>
                <button mat-stroked-button color="primary" type="button" (click)="addFamilyMember()">
                  Add Family Member
                  <mat-icon class="ml-1">add</mat-icon>
                </button>
              </div>

              <div formArrayName="familyMembers" class="family-member-wrapper">
                <mat-card class="family-card" *ngFor="let member of familyMembers.controls; let i = index"
                  [formGroupName]="i">

                  <div class="family-card__head">
                    <div class="family-card__title">
                      Family Member {{ i + 1 }}
                    </div>

                    <button mat-icon-button color="warn" type="button" class="family-card__delete"
                      (click)="removeFamilyMember(i)">
                      <mat-icon>delete</mat-icon>
                    </button>
                  </div>
                  <mat-divider></mat-divider>

                  <mat-card-content class="family-card__content">
                    <div class="grid grid-cols-1 gap-4 md:grid-cols-2 lg:grid-cols-3 auto-rows-min">
                      <mat-form-field appearance="outline" class="w-full">
                        <mat-label>Code</mat-label>
                        <input matInput formControlName="code" readonly />
                      </mat-form-field>

                      <mat-form-field appearance="outline" class="w-full">
                        <mat-label>First Name</mat-label>
                        <input matInput formControlName="firstName" />
                        <mat-error *ngIf="member.get('firstName')?.invalid && member.get('firstName')?.touched">
                          First name is required.
                        </mat-error>
                      </mat-form-field>

                      <mat-form-field appearance="outline" class="w-full">
                        <mat-label>Last Name</mat-label>
                        <input matInput formControlName="lastName" />
                        <mat-error *ngIf="member.get('lastName')?.invalid && member.get('lastName')?.touched">
                          Last name is required.
                        </mat-error>
                      </mat-form-field>

                      <mat-form-field appearance="outline" class="w-full">
                        <mat-label>Email</mat-label>
                        <input matInput formControlName="email" />
                        <mat-error *ngIf="member.get('email')?.invalid && member.get('email')?.touched">
                          Enter a valid email.
                        </mat-error>
                      </mat-form-field>

                      <mat-form-field appearance="outline" class="w-full">
                        <mat-label>Mobile</mat-label>
                        <input matInput formControlName="mobile" />
                      </mat-form-field>

                      <mat-form-field appearance="outline" class="w-full">
                        <mat-label>Units</mat-label>
                        <mat-select formControlName="unitIds" multiple>
                          <mat-option *ngFor="let unit of units" [value]="unit.id">
                            {{ unit.buildingName || unit.building?.buildingName || unit.building?.name }} - {{
                            unit.unitName || unit.name }}
                          </mat-option>
                        </mat-select>
                      </mat-form-field>

                      <mat-form-field appearance="outline" class="w-full">
                        <mat-label>Face Id</mat-label>
                        <input matInput formControlName="faceId" />
                      </mat-form-field>

                      <mat-form-field appearance="outline" class="w-full">
                        <mat-label>Finger Id</mat-label>
                        <input matInput formControlName="fingerId" />
                      </mat-form-field>

                      <mat-form-field appearance="outline" class="w-full">
                        <mat-label>Card Id</mat-label>
                        <input matInput formControlName="cardId" />
                      </mat-form-field>

                      <mat-form-field appearance="outline" class="w-full">
                        <mat-label>Qr Id</mat-label>
                        <input matInput formControlName="qrId" />
                      </mat-form-field>
                      <mat-checkbox class="w-full" formControlName="isResident">Add User</mat-checkbox>
                    </div>
                  </mat-card-content>
  <!-- FAMILY MEMBER PROFILE PHOTO -->
<div class="w-full lg:col-span-3 profile-photo-section mt-4">

  <label class="profile-photo-title">
    Family Member Photo
  </label>

  <div class="profile-photo-card">
    <img
  *ngIf="member.get('profilePhoto')?.value"
  [src]="getFamilyPhotoPreview(member)"
  class="profile-photo-img"
  alt="Family Member Photo"
/>


    <div *ngIf="!member.get('profilePhoto')?.value"
         class="profile-photo-placeholder">
      <mat-icon>person</mat-icon>
      <span>No Photo</span>
    </div>
  </div>

  <button
  mat-flat-button
  color="primary"
  type="button"
  class="upload-photo-btn"
  (click)="familyPhotoInput.click()">

  <mat-icon>photo_camera</mat-icon>
  Upload Photo
</button>


  <input
    #familyPhotoInput
    type="file"
    accept="image/*"
    hidden
    (change)="onFamilyPhotoSelected($event, i)" />
</div>


                </mat-card>
              </div>
            </div>
                        <div class="flex justify-center mt-6">
              <button mat-flat-button color="primary" type="submit" class="app-button back-Green">
                Save
              </button>
            </div>
          </form>
        </mat-card-content>
      </mat-card>
    </div>
  </div>
</div>
